<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>2025å¹´ã‚’é§†ã‘æŠœã‘ã‚‹å¹´è³€çŠ¶</title>
    <style>
        :root {
            /* åŸºæœ¬ã‚µã‚¤ã‚º */
            --canvas-width: 680px;
            --canvas-height: 456px;
            --cal-width: 420px;

            /* ã‚°ãƒªãƒƒãƒ‰é…ç½® */
            --grid-top: 110px;
            --grid-left: 15px;
            --grid-width: 390px;
            --grid-height: 340px;

            /* ãƒã‚¹ã®è‰²ï¼ˆRGBAï¼‰ */
            --bg-gold:   rgba(255, 215, 0, 0.3);
            --bg-purple: rgba(147, 112, 219, 0.3);
            --bg-blue:   rgba(0, 191, 255, 0.3);
            --bg-pink:   rgba(255, 105, 180, 0.4);
            --bg-green:  rgba(46, 204, 113, 0.3);
            --bg-orange: rgba(230, 126, 34, 0.3);
            --bg-red:    rgba(220, 20, 0, 0.5);
            
            --font-main: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", sans-serif;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f0f0f0;
            font-family: var(--font-main);
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        #game-container {
            position: relative;
            width: var(--canvas-width);
            height: var(--canvas-height);
            background-color: #fff;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex;
            overflow: hidden;
            margin-top: 20px;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å…±é€š */
        .sidebar {
            width: 130px;
            height: 100%;
            background: #2c3e50;
            color: white;
            padding: 15px 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            z-index: 20;
        }
        .status-label { font-size: 11px; color: #95a5a6; margin-bottom: 2px; text-transform: uppercase; }
        .status-value { font-size: 18px; font-weight: bold; color: #f1c40f; transition: color 0.3s; }
        .multiplier-value { color: #2ecc71; }
        #dice-cost-display { color: #ecf0f1; letter-spacing: 1px; }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ */
        .calendar-area { position: relative; width: var(--cal-width); height: 100%; }
        #calendar-bg { width: 100%; height: 100%; display: block; }
        #grid-overlay {
            position: absolute;
            top: var(--grid-top); left: var(--grid-left);
            width: var(--grid-width); height: var(--grid-height);
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }
        .cell { border: 1px solid rgba(0,0,0,1); transition: background-color 0.3s; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼é§’ */
        #player-token {
            position: absolute;
            width: 28px; height: 28px;
            background: #e74c3c;
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            transform: translate(-50%, -50%);
            z-index: 10;
            pointer-events: none;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 15px; text-align: center; width: 260px;
        }
        .bonus-option {
            display: block; width: 100%; margin: 10px 0; padding: 12px;
            background: #f1c40f; border: none; border-radius: 8px;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .bonus-option:hover { background: #f39c12; transform: translateY(-2px); }

        /* UIã‚¨ãƒªã‚¢ */
        .controls { margin-top: 25px; text-align: center; width: var(--canvas-width); }
        button#dice-btn {
            padding: 12px 40px; font-size: 20px; font-weight: bold;
            background: #3498db; color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 4px #2980b9;
        }
        button#dice-btn:active { transform: translateY(2px); box-shadow: 0 2px #2980b9; }
        body.modal-open .controls button { pointer-events: none; opacity: 0.5; filter: grayscale(1); }

        #status-log { color: #666; margin-top: 15px; font-size: 0.9em; }

        #event-log {
            font-size: 1em; color: #2c3e50; height: 120px; overflow-y: auto;
            margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.5);
            border-radius: 8px; text-align: left; display: flex;
            flex-direction: column; gap: 5px;
        }

        .log-entry {
            border-bottom: 1px solid #ddd; padding-bottom: 3px;
            animation: fadeInDown 0.3s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ç‰¹æ®Šã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã®è™¹è‰²æ  */
        .cell.special-day {
            background-color: transparent !important;
            border: 4px double transparent !important;
            border-image: linear-gradient(45deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff) 1 !important;
            position: relative; z-index: 5; animation: rainbow-glow 3s linear infinite;
        }

        @keyframes rainbow-glow {
            0% { filter: hue-rotate(0deg); box-shadow: 0 0 5px rgba(255,255,255,0.5); }
            50% { box-shadow: 0 0 15px rgba(255,255,255,0.8); }
            100% { filter: hue-rotate(360deg); box-shadow: 0 0 5px rgba(255,255,255,0.5); }
        }
    </style>
</head>
<body>

    <div id="game-container">
        <div class="sidebar">
            <div>
                <div class="status-label">æ‰€æŒé‡‘</div>
                <div id="money-display" class="status-value">0å††</div>
            </div>
            <div>
                <div class="status-label">ç¾åœ¨ã®æœˆ</div>
                <div id="month-display" style="font-size: 18px; font-weight: bold;">1æœˆ</div>
            </div>
        </div>

        <div class="calendar-area">
            <img id="calendar-bg" src="calendar/01gatu.png" alt="Calendar">
            <div id="grid-overlay"></div>
            <div id="player-token"></div>
        </div>

        <div class="sidebar" style="border-left: 1px solid #1a252f;">
            <div>
                <div class="status-label">åå…¥å€ç‡</div>
                <div class="status-value multiplier-value">x<span id="multiplier-display">1.0</span></div>
            </div>
            <div style="margin-top: 20px;">
                <div class="status-label">ã‚µã‚¤ã‚³ãƒ­ä»£</div>
                <div id="dice-cost-display" class="status-value" style="font-size: 16px;">1,000å††</div>
            </div>
            <div style="margin-top: 15px; border-top: 1px solid #34495e; padding-top: 10px;">
                <div class="status-label" style="margin-bottom: 5px;">ãƒã‚¹æƒ…å ± (å˜ä¾¡ Ã— Lv)</div>
                <div id="level-list" style="font-size: 11px; color: #ecf0f1; line-height: 1.6;"></div>
            </div>
        </div>

        <div id="modal-overlay" class="modal-overlay">
            <div class="modal-content">
                <h3>ğŸŒ™ æ¯æœˆãƒœãƒ¼ãƒŠã‚¹</h3>
                <p style="font-size: 0.9em; color: #666;">ãƒœãƒ¼ãƒŠã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                <button class="bonus-option" onclick="applyBonus('money')">ğŸ’° æ‰€æŒé‡‘ +50000å††</button>
                <button class="bonus-option" onclick="applyBonus('move')">ğŸƒ 3ãƒã‚¹é€²ã‚€</button>
                <button class="bonus-option" onclick="applyBonus('multiplier')">ğŸ“ˆ å€ç‡ +0.2</button>
            </div>
        </div>

        <div id="event-modal-overlay" class="modal-overlay" style="background: rgba(0,0,0,0.85); z-index: 110;">
            <div style="background: white; padding: 20px; border-radius: 15px; text-align: center; width: 320px;">
                <h2 id="special-event-title" style="margin-top: 0; color: #333; font-size: 1.2em;"></h2>
                <img id="special-event-img" src="" style="width: 100%; height: auto; border-radius: 10px; margin: 10px 0;">
                <p id="special-event-text" style="color: #555; font-size: 0.9em; line-height: 1.5;"></p>
                <div id="special-event-buttons" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <button id="dice-btn" onclick="rollDice()">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
        <p id="status-log">2025å¹´ã‚¹ã‚¿ãƒ¼ãƒˆï¼</p>
        <p id="event-log"></p>
    </div>
    

<script>
    // ==========================================
    // 1. å®šæ•°ãƒ»è¨­å®š
    // ==========================================
    const GAME_CONFIG = {
        DICE_COST: 1000,
        BONUS_MONEY_BASE: 50000,
        BONUS_MULTIPLIER_ADD: 0.2,
        BONUS_MOVE_STEPS: 3,
        MAX_GRID_CELLS: 42,
        MAX_WEIGHT: 20,    // ID 1 (å‡ºç¾ç‡æœ€å¤§) ã®æ™‚ã®é‡ã¿
        WEIGHT_STEP: 3,    // IDãŒ1ä¸ŠãŒã‚‹ã”ã¨ã«æ¸›ã‚‰ã™é‡ã¿ã®é‡
        EMPTY_WEIGHT: 15,   // ç©ºç™½ãƒã‚¹ã®é‡ã¿
        COLORS: { TEXT_GOLD: "#f1c40f", TEXT_DEBT: "#ff4d4d" },
        EVENT_WEIGHTS: { 1: 10, 2: 8, 3: 12, 4: 5, 5: 15, 6: 7, 7: 3 }
    };

    const EVENT_TYPES = {
        1: { name: "é‡‘ãƒã‚¹", color: "var(--bg-gold)", baseIncome: 1000, level: 1, weight: 20 },
        2: { name: "ç´«ãƒã‚¹", color: "var(--bg-purple)", baseIncome: 1500, level: 1, weight: 17 },
        3: { name: "é’ãƒã‚¹", color: "var(--bg-blue)", baseIncome: 2000, level: 1, weight: 14 },
        4: { name: "æ¡ƒãƒã‚¹", color: "var(--bg-pink)", baseIncome: 2500, level: 1, weight: 11 },
        5: { name: "ç·‘ãƒã‚¹", color: "var(--bg-green)", baseIncome: 3000, level: 1, weight: 8 },
        6: { name: "æ©™ãƒã‚¹", color: "var(--bg-orange)", baseIncome: 3500, level: 1, weight: 5 },
        7: { name: "èµ¤ãƒã‚¹", color: "var(--bg-red)", baseIncome: 4000, level: 1, weight: 2 }
    };

    const MONTHS_DATA = [
        { name: "1æœˆ", img: "calendar/01gatu.png", offset: 3, days: 31, events: {} },
        { name: "2æœˆ", img: "calendar/02gatu.png", offset: 6, days: 28, events: {} },
        { name: "3æœˆ", img: "calendar/03gatu.png", offset: 6, days: 31, events: {} },
        { name: "4æœˆ", img: "calendar/04gatu.png", offset: 2, days: 30, events: {} },
        { name: "5æœˆ", img: "calendar/05gatu.png", offset: 4, days: 31, events: {} },
        { name: "6æœˆ", img: "calendar/06gatu.png", offset: 0, days: 30, events: {} },
        { name: "7æœˆ", img: "calendar/07gatu.png", offset: 2, days: 31, events: {} },
        { name: "8æœˆ", img: "calendar/08gatu.png", offset: 5, days: 31, events: {} },
        { name: "9æœˆ", img: "calendar/09gatu.png", offset: 1, days: 30, events: {} },
        { name: "10æœˆ", img: "calendar/10gatu.png", offset: 3, days: 31, events: {} },
        { name: "11æœˆ", img: "calendar/11gatu.png", offset: 6, days: 30, events: {} },
        { name: "12æœˆ", img: "calendar/12gatu.png", offset: 1, days: 31, events: {} }
    ];

    const SPECIAL_DATE_EVENTS = {
        "1-1": {
            title: "ğŸ ã‚ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†",
            img: "images/2025.jpg",
            text: "ãŠå¹´ç‰ã‚’ã‚‚ã‚‰ã„ã¾ã—ãŸï¼",
            bonusMoney: 30000, // ã“ã“ã§å€‹åˆ¥é‡‘é¡ã‚’æŒ‡å®šï¼ˆæŒ‡å®šãªã—ãªã‚‰10ä¸‡ï¼‰
        },
        "1-21": {
            title: "ğŸ¨ æ„›â™¡ã‚¹ã‚¯ãƒªï½ãƒ ï¼",
            img: "images/aice.jpg",
            text: "ãƒ«ãƒ“ã‚£ã¡ã‚ƒãƒ¼ã‚“ï¼ã¯ãƒ¼ã„ï¼ä½•ãŒå¥½ãï¼Ÿãƒãƒ§ã‚³ãƒŸãƒ³ãƒˆã‚ˆã‚Šã‚‚ ã‚ãƒ»ãªãƒ»ãŸ",
            bonusMoney: 10000,
        },
        "2-14": {
            title: "ã‚¨ãƒƒãƒ›ã‚¨ãƒƒãƒ›",
            img: "images/ehho.png",
            text: "2025å¹´ã¯çµ‚ã‚ã‚Šã£ã¦ä¼ãˆãªãã‚ƒ",
            bonusMoney: 10000,
        },
        "3-4": {
            title: "ãŠå‰ãã‚Œæ¬¡ã‚„ã£ãŸã‚‰ãƒã‚¸ã§ã€ã“ã‚Œã€Ÿã ã‹ã‚‰ãª",
            img: "images/kore.png",
            text: "å…ƒãƒã‚¿ç‰¹å®šã®ç”»åƒã˜ã‚ƒãªã„ã‚“ã§å„è‡ªæ¤œç´¢ã—ã¦ã­",
            bonusMoney: 10000,
        },
        "3-23": {
            title: "è¦‹ãªã‚ˆâ€¦ã‚ªãƒ¬ã®å¸ã‚’â€¦",
            img: "images/oreno.png",
            text: "æ¨ã—å£°å„ªã®ãŸã‚ã«ãƒãƒ³ã‚¬æ›¸ã„ã¦ã‚¢ãƒ‹ãƒ¡åŒ–ã¾ã§ã•ã›ãŸã¨ã„ã†ãƒˆãƒ³ãƒ‡ãƒ¢é€¸è©±",
            bonusMoney: 10000,
        },
        "4-13": {
            title: "å¤§é˜ªãƒ»é–¢è¥¿ä¸‡åš",
            img: "images/myaku.jpg",
            text: "è¡Œã‘ãªã£ãŸâ€¦",
            bonusMoney: 10000,
        },
        "5-2": {
            title: "ãƒ¡ã‚¿ãƒ¢ãƒ³",
            img: "images/meta.jpg",
            text: "è¦‹ã¦â†’(https://www.pixiv.net/users/20522049)",
            bonusMoney: 10000,
        },
        "5-9": {
            title: "çŒ«å½±ãƒãƒ¼ã‚º",
            img: "images/kageneko.jpg",
            text: "ã‚ã‚Šã¨å¥½ã",
            bonusMoney: 10000,
        },
        "5-31": {
            title: "ãŠè¿”äº‹ã¾ã ã‚«ãƒŠ?ãŠã˜ã•ã‚“æ§‹æ–‡!",
            img: "images/ozi.jpg",
            text: "å€‹äººçš„ã«ä¸€éæ€§ã®ãƒã‚¿ç³»ã¯å¥½ã¿ã§ãªã„ãŒã€æ›²ã¯è‰¯ã„ã¨æ€ã†",
            bonusMoney: 10000,
        },
        "6-17": {
            title: "Shadowverse: Worlds Beyond",
            img: "images/syad.jpg",
            text: "ç§ã¯åŠå¹´ã‚‚ã“ã‚“ãªã‚²ãƒ¼ãƒ ã‚„ã£ã¦ã‚‹ã®ã‹",
            bonusMoney: 10000,
        },
        "6-21": {
            title: "",
            img: "images/naruto.png",
            text: "ä»Šã“ã‚Œ",
            bonusMoney: 10000,
        },
        "6-24": {
            title: "æ©Ÿå‹•æˆ¦å£«Gundam GQuuuuuuX",
            img: "images/ganda.jpg",
            text: "ã‚¬ãƒ³ãƒ€ãƒ åˆè¦‹ã ã£ãŸã‘ã©é¢ç™½ã‹ã£ãŸã‚ˆ",
            bonusMoney: 10000,
        },
        "7-10": {
            title: "å®¹æ…‹æ€¥å¤‰ã€FULLã€‘",
            img: "images/asmr.jpg",
            text: "ã“ã‚ŒBANã•ã‚Œãªã„ã‹ï¼Ÿ",
            bonusMoney: 10000,
        },
        "7-15": {
            title: "Grok Ani",
            img: "images/ani.jpg",
            text: "ã‚¤ãƒ¼ãƒ­ãƒ³ã®è‰¯ã„å´é¢",
            bonusMoney: 10000,
        },
        "7-18": {
            title: "åŠ‡å ´ç‰ˆã€Œé¬¼æ»…ã®åˆƒã€ç„¡é™åŸç·¨ ã€ç¬¬ä¸€ç«  çŒ—çª©åº§å†æ¥ã€",
            img: "images/akaza.jpg",
            text: "ä¸Šé™ã®å‚ï¼ï¼Ÿãªãœã“ã“ã«ï¼ï¼Ÿ",
            bonusMoney: 10000,
        },
        "7-19": {
            title: "é­”æ³•å°‘å¥³ãƒé­”å¥³è£åˆ¤",
            img: "images/manosa.png",
            text: "âœ‹ã€Œã¡ã‚‡ã£ã¨å¾…ã£ã¦ï¼ã€å€‹äººçš„ç¥ã‚²ãƒ¼ãªã®ã§æ˜¯é",
            bonusMoney: 10000,
        },
        "7-21": {
            title: "wplace",
            img: "images/wplace.png",
            text: "ãã£ã“ãƒ¼ã§è’ã‚‰ã•ã‚Œã¦å¯å“€ãã†ã ã£ãŸ",
            bonusMoney: 10000,
        },
        "8-20": {
            title: "ã¾ã‚‹ã§æœ¬ç‰©ã®ã‚ˆã†ã§ã™",
            img: "images/same.jpg",
            text: "å®¶ã§ã‚‚ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼ã§ã‚‚ã€ã‚¨ãƒƒãƒãªæœã‚’ç€ã¦å‹é”ã‚„å®¶æ—ã‚’æ€–ãŒã‚‰ã›ã¾ã—ã‚‡ã†ï¼",
            bonusMoney: 10000,
        },
        "9-8": {
            title: "ã†ã¾ããƒ˜ãƒƒãƒ€ãƒ¼ã«åã¾ã‚‰ãªã„",
            img: "images/header.png",
            text: "ã†ã¾ãã„ã£ãŸã®ã§ãƒ˜ãƒƒãƒ€ãƒ¼è¦‹ã¦ãã ã•ã„",
            bonusMoney: 10000,
        },
        "9-10": {
            title: "ã‚²ã‚¤ãƒªãƒ¼ã«ã‚ã‚ŠãŒã¨ã†ã¨è¨€ã£ã¦",
            img: "images/geiri.jpg",
            text: "ãªã‚“ã‹æ€ã£ãŸã»ã©æµè¡Œã‚‰ãªã‹ã£ãŸ",
            bonusMoney: 10000,
        },
        "9-19": {
            title: "åŠ‡å ´ç‰ˆã€ãƒã‚§ãƒ³ã‚½ãƒ¼ãƒãƒ³ ãƒ¬ã‚¼ç¯‡ã€",
            img: "images/reze.png",
            text: "è‡ªèªãƒ¬ãœã§ã‚‚ã„ã„ã¨æ€ã„ã¾ã™",
            bonusMoney: 10000,
        },
        "9-23": {
            title: "ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ»ãƒ–ãƒ¬ã‚¤ãƒ³ãƒ­ãƒƒãƒˆ",
            img: "images/itari.png",
            text: "ãƒˆã‚¥ãƒ³ãƒˆã‚¥ãƒ³ãƒˆã‚¥ãƒ³â€¦â€¦ãƒˆã‚¥ãƒ³ãƒˆã‚¥ãƒ³ãƒˆã‚¥ãƒ³â€¦â€¦ï¼ˆãƒŠãƒ‹ã‚³ãƒ¬ï¼‰",
            bonusMoney: 10000,
        },
        "10-3": {
            title: "é‡åŸã²ã‚ã— æ˜¼ãƒ¡ã‚·ã®æµå„€",
            img: "images/hirosi.jpg",
            text: "é ˜ åŸŸ å±• é–‹",
            bonusMoney: 10000,
        },
        "10-14": {
            title: "ãƒã‚±ãƒ¢ãƒ³ãƒ¬ã‚¸ã‚§ãƒ³ã‚º Z-A",
            img: "images/za.png",
            text: "ã“ã‚Œã¨å¥³è£…ã§ãã‚‹ã“ã¨ã—ã‹çŸ¥ã‚‰ãªã„",
            bonusMoney: 10000,
        },
        "10-16": {
            title: "ã‚¤ãƒŠã‚ºãƒã‚¤ãƒ¬ãƒ–ãƒ³ è‹±é›„ãŸã¡ã®ãƒ´ã‚£ã‚¯ãƒˆãƒªãƒ¼ãƒ­ãƒ¼ãƒ‰",
            img: "images/inazuma.jpg",
            text: "8å¹´è¶Šã—ã®ç™ºå£²ï¼",
            bonusMoney: 10000,
        },
        "11-13": {
            title: "ã‚°ã‚¨ãƒ¼æ­»ã‚“ã ãƒ³ã‚´",
            img: "images/gue-.jpg",
            text: "æˆä»ã—ã¦ã‚¯ãƒ¬ãƒ¡ãƒ³ã‚¹",
            bonusMoney: 10000,
        },
        "12-25": {
            title: "ãƒ¡ãƒªãƒ¼ã‚¯ãƒªã‚¹ãƒã‚¹ï¼ï¼",
            img: "images/chicken.jpg",
            text: "ä»Šå¹´ã‚‚ãƒã‚­ãƒ³æ¸©ã‚ã¦ã¾ã™ã‹ï¼Ÿ",
            bonusMoney: 10000,
        }
    };

    // ==========================================
    // 2. çŠ¶æ…‹ç®¡ç† & DOMã‚­ãƒ£ãƒƒã‚·ãƒ¥
    // ==========================================
    let state = { currentMonthIdx: 0, currentDay: 1, money: 0, multiplier: 1.0 };

    const UI = {
        overlay: document.getElementById('grid-overlay'),
        token: document.getElementById('player-token'),
        bg: document.getElementById('calendar-bg'),
        month: document.getElementById('month-display'),
        money: document.getElementById('money-display'),
        multiplier: document.getElementById('multiplier-display'),
        diceCost: document.getElementById('dice-cost-display'),
        levelList: document.getElementById('level-list'),
        bonusModal: document.getElementById('modal-overlay'),
        eventModal: document.getElementById('event-modal-overlay'),
        statusLog: document.getElementById('status-log'),
        eventLog: document.getElementById('event-log'),
        spTitle: document.getElementById('special-event-title'),
        spImg: document.getElementById('special-event-img'),
        spText: document.getElementById('special-event-text'),
        spButtons: document.getElementById('special-event-buttons')
    };

    // ==========================================
    // 3. åˆæœŸåŒ– & è¡¨ç¤ºæ›´æ–°
    // ==========================================
    function initGrid() {
        UI.overlay.innerHTML = '';
        for (let i = 0; i < GAME_CONFIG.MAX_GRID_CELLS; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}`;
            UI.overlay.appendChild(cell);
        }
        UI.diceCost.innerText = GAME_CONFIG.DICE_COST.toLocaleString() + "å††";
        generateMonthlyEvents(state.currentMonthIdx);
        updateCalendarVisuals();
        updateView();
    }

    function updateLevelDisplay() {
        if (!UI.levelList) return;
        UI.levelList.innerHTML = '';
        Object.entries(EVENT_TYPES).forEach(([id, ev]) => {
            const item = document.createElement('div');
            item.innerHTML = `<span style="color:${ev.color}">â– </span> ${ev.name}: ${ev.baseIncome.toLocaleString()} Ã— <span style="color:#f1c40f">Lv.${ev.level}</span>`;
            UI.levelList.appendChild(item);
        });
    }

    function updateCalendarVisuals() {
        const month = MONTHS_DATA[state.currentMonthIdx];
        document.querySelectorAll('.cell').forEach((cell, i) => {
            cell.style.backgroundColor = 'transparent';
            cell.classList.remove('special-day');
            
            const day = i - month.offset + 1;
            if (day >= 1 && day <= month.days) {
                const dateKey = `${state.currentMonthIdx + 1}-${day}`;
                if (SPECIAL_DATE_EVENTS[dateKey]) {
                    cell.classList.add('special-day');
                } else {
                    const eventId = month.events[day];
                    if (EVENT_TYPES[eventId]) cell.style.backgroundColor = EVENT_TYPES[eventId].color;
                }
            }
        });
    }

    function updateView(skipEvent = false) {
        const month = MONTHS_DATA[state.currentMonthIdx];
        UI.bg.src = month.img;
        UI.month.innerText = month.name;
        UI.multiplier.innerText = state.multiplier.toFixed(1);

        updateLevelDisplay();
        if (!skipEvent) checkEvents();
        updateTokenPosition();

        updateCalendarVisuals();
    }

    function updateTokenPosition() {
        const month = MONTHS_DATA[state.currentMonthIdx];
        const cellIndex = month.offset + state.currentDay - 1;
        const target = document.getElementById(`cell-${cellIndex}`);
        if (target) {
            const x = target.offsetLeft + UI.overlay.offsetLeft + (target.offsetWidth / 2);
            const y = target.offsetTop + UI.overlay.offsetTop + (target.offsetHeight / 2);
            UI.token.style.left = x + 'px';
            UI.token.style.top = y + 'px';
        }
    }

    // ==========================================
    // 4. ã‚¤ãƒ™ãƒ³ãƒˆãƒ­ã‚¸ãƒƒã‚¯
    // ==========================================
    function checkEvents() {
        const dateKey = `${state.currentMonthIdx + 1}-${state.currentDay}`;
        const spEvent = SPECIAL_DATE_EVENTS[dateKey];
        
        if (spEvent) {
            showSpecialEvent(spEvent);
            if (spEvent.action) spEvent.action();
        } else {
            const month = MONTHS_DATA[state.currentMonthIdx];
            handleEvents(month.events[state.currentDay]);
        }
    }

    function handleEvents(id) {
        if (!id) {
            pushLog(`ç‰¹ã«ãªã—`);
            return;
        }

        const event = EVENT_TYPES[id];
        
        // 1. åå…¥ã‚’è¨ˆç®—ï¼ˆç¾åœ¨ã®ãƒ¬ãƒ™ãƒ«ã§è¨ˆç®—ï¼‰
        const income = event.baseIncome * event.level;
        addMoney(income, `${event.name} (Lv.${event.level})`);

        // 2. ãã®ãƒã‚¹ã®ãƒ¬ãƒ™ãƒ«ã‚’ 1 ä¸Šã’ã‚‹
        event.level += 1;
        pushLog(`${event.name}ã®ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã£ãŸï¼ (Lv.${event.level-1} â†’ Lv.${event.level})`);

        // 3. å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®ãƒ¬ãƒ™ãƒ«è¡¨ç¤ºã‚’æœ€æ–°ã«ã™ã‚‹
        updateLevelDisplay();
    }

    function generateMonthlyEvents(idx) {
        const month = MONTHS_DATA[idx];
        month.events = {};
        for (let d = 1; d <= month.days; d++) {
            const id = getRandomEventId();
            if (id) month.events[d] = id;
        }
    }

    function getRandomEventId() {
        const ids = Object.keys(EVENT_TYPES).map(Number);
        const totalEventWeight = ids.reduce((sum, id) => sum + EVENT_TYPES[id].weight, 0);
        const totalWeight = totalEventWeight + GAME_CONFIG.EMPTY_WEIGHT;
        
        let r = Math.random() * totalWeight;
        for (const id of ids) {
            if (r < EVENT_TYPES[id].weight) return id;
            r -= EVENT_TYPES[id].weight;
        }
        return null;
    }

    function showSpecialEvent(ev) {
        UI.spTitle.innerText = ev.title;
        UI.spImg.src = ev.img;
        UI.spImg.style.width = '100%';         // æ¨ªå¹…ã„ã£ã±ã„ã«åºƒã’ã‚‹
        UI.spImg.style.height = '250px';       // é«˜ã•ã‚’250pxã«å›ºå®šï¼ˆã“ã“ã¯ãŠå¥½ã¿ã§ï¼‰
        UI.spImg.style.objectFit = 'contain';  // â˜…æ¯”ç‡ã‚’ä¿ã£ãŸã¾ã¾æ ã«åã‚ã‚‹
        UI.spImg.style.display = 'block';      // å´©ã‚Œé˜²æ­¢
        UI.spImg.style.margin = '0 auto 15px'
        
        const displayAmount = ev.bonusMoney !== undefined ? ev.bonusMoney : 100000;
        UI.spText.innerText = `${ev.text}\nï¼ˆå ±é…¬ ${displayAmount.toLocaleString()}å†† ï¼‹ ç‰¹å…¸é¸æŠï¼‰`;
        
        UI.spButtons.innerHTML = '';

        // æœˆæ›¿ã‚ã‚Šã¨åŒã˜ã‚ˆã†ã«ã€Œãƒ¬ãƒ™ãƒ«ã€ã¨ã€Œå‡ºç¾ç‡ã€ã®å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å€™è£œã«ã™ã‚‹
        let candidates = [];
        Object.keys(EVENT_TYPES).forEach(id => {
            candidates.push({ type: 'LEVEL', id: Number(id) });
            candidates.push({ type: 'WEIGHT', id: Number(id) });
        });

        // ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤é¸å‡º
        const selectedOptions = candidates.sort(() => 0.5 - Math.random()).slice(0, 3);

        selectedOptions.forEach(opt => {
            const typeData = EVENT_TYPES[opt.id];
            const btn = document.createElement('button');
            
            // ãƒ©ãƒ™ãƒ«ã®å‡ºã—åˆ†ã‘
            const label = opt.type === 'LEVEL' ? `${typeData.name} Lv+5` : `${typeData.name} å‡ºç¾ç‡UP`;
            btn.innerText = label;
            
            // ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆè‰²ã¯EVENT_TYPESã®å¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
            btn.style.cssText = `flex: 1; padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background: ${typeData.color.replace('0.3', '1')}; color: black; font-size: 11px;`;
            
            
            btn.onclick = () => {
                // é¸æŠã•ã‚ŒãŸ type (LEVEL ã‹ WEIGHT) ã‚’æ¸¡ã—ã¦å®Ÿè¡Œ
                applyBonusEffect(opt.type, opt.id, ev.bonusMoney); 
                closeSpecialEvent();
            };
            UI.spButtons.appendChild(btn);
        });

        UI.eventModal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function closeSpecialEvent() {
        UI.eventModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        pushLog("ç‰¹æ®Šã‚¤ãƒ™ãƒ³ãƒˆã‚’ç¢ºèªã—ã¾ã—ãŸã€‚");
    }

    // ==========================================
    // 5. ã‚²ãƒ¼ãƒ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    // ==========================================
    function rollDice(isFree = false) {
        if (document.body.classList.contains('modal-open')) return;
        
        // å®Œå…¨ã«çµ‚äº†ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢ã«ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒå‡ºã¦ã„ãŸã‚‰æŒ¯ã‚‰ã›ãªã„ï¼‰
        if (document.getElementById('new-year-overlay').style.display === 'flex') return;

        if (!isFree) subMoney(GAME_CONFIG.DICE_COST, "ã‚µã‚¤ã‚³ãƒ­ä»£");
        const steps = Math.floor(Math.random() * 10) + 1;
        movePlayer(steps);
    }

    function movePlayer(steps) {
        state.currentDay += steps;
        const month = MONTHS_DATA[state.currentMonthIdx];

        // æœˆæœ«åˆ¤å®š
        if (state.currentDay > month.days) {
            // 12æœˆã‹ã¤æœˆæœ«ã‚’è¶ŠãˆãŸå ´åˆï¼ˆï¼å¹´è¶Šã—ï¼‰
            if (state.currentMonthIdx >= 11) {
                state.currentDay = month.days; // è¡¨ç¤ºä¸Šã¯31æ—¥ã«
                updateView();
                // å°‘ã—ã ã‘é…ã‚‰ã›ã¦æ¼”å‡ºã‚’å‡ºã™ã¨ã‚¹ãƒ ãƒ¼ã‚ºã§ã™
                setTimeout(showHappyNewYear, 500); 
                return;
            }

            // 11æœˆä»¥å‰ãªã‚‰æ¬¡ã®æœˆã¸
            state.currentDay -= month.days;
            state.currentMonthIdx++; 
            
            generateMonthlyEvents(state.currentMonthIdx);
            updateCalendarVisuals();
            updateView(true);
            showBonusModal();
            UI.statusLog.innerText = `${steps} é€²ã¿ã¾ã—ãŸï¼ˆç¾åœ¨: ${MONTHS_DATA[state.currentMonthIdx].name}${state.currentDay}æ—¥ï¼‰`;
        } else {
            UI.statusLog.innerText = `${steps} é€²ã¿ã¾ã—ãŸï¼ˆç¾åœ¨: ${state.currentDay}æ—¥ï¼‰`;
            updateView();
        }
    }

    function showBonusModal() {
        if (!UI.bonusModal) return;

        // é¸æŠè‚¢å€™è£œã‚’ä½œæˆï¼ˆå„IDã«å¯¾ã—ã¦ã€Œãƒ¬ãƒ™ãƒ«ã€ã¨ã€Œå‡ºç¾ç‡ã€ã®2ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
        let candidates = [];
        Object.keys(EVENT_TYPES).forEach(id => {
            candidates.push({ type: 'LEVEL', id: Number(id) });
            candidates.push({ type: 'WEIGHT', id: Number(id) });
        });

        // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦3ã¤é¸ã¶
        const selectedOptions = candidates.sort(() => 0.5 - Math.random()).slice(0, 3);

        const modalContent = UI.bonusModal.querySelector('.modal-content');
        modalContent.innerHTML = `
            <h3>ğŸŒ™ æ¯æœˆãƒœãƒ¼ãƒŠã‚¹</h3>
            <p>å ±é…¬10ä¸‡å†† ï¼‹ ç‰¹å…¸ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        `;

        selectedOptions.forEach(opt => {
            const ev = EVENT_TYPES[opt.id];
            const btn = document.createElement('button');
            btn.className = 'bonus-option';
            
            const label = opt.type === 'LEVEL' ? `${ev.name} Lv+5` : `${ev.name} å‡ºç¾ç‡UP`;
            btn.innerHTML = `<span style="color:${ev.color.replace('0.3', '1')}">â– </span> ${label}`;
            
            btn.onclick = () => {
                applyBonusEffect(opt.type, opt.id);
                updateDiceCost(); // æ¯æœˆãƒœãƒ¼ãƒŠã‚¹æ™‚ã®ã¿ã‚µã‚¤ã‚³ãƒ­ä»£æ›´æ–°
                UI.bonusModal.style.display = 'none';
                document.body.classList.remove('modal-open');
                updateView(true);
            };
            modalContent.appendChild(btn);
        });

        UI.bonusModal.style.display = 'flex';
        document.body.classList.add('modal-open');
    }

    function applyBonus(selectedEventId) {
        applyBonusEffect(selectedEventId); // 10ä¸‡å††åŠ ç®—ã¨Lv+5

        // ãƒœãƒ¼ãƒŠã‚¹é©ç”¨å¾Œã®æ‰€æŒé‡‘ã«åŸºã¥ã„ã¦ã‚µã‚¤ã‚³ãƒ­ä»£ã‚’æ›´æ–°
        updateDiceCost();

        UI.bonusModal.style.display = 'none';
        document.body.classList.remove('modal-open');
        updateView(true);
    }

    // é‡‘é¡ã¨ã‚¤ãƒ™ãƒ³ãƒˆIDã‚’å—ã‘å–ã£ã¦é©ç”¨ã™ã‚‹
    function applyBonusEffect(type, id, amount) {
        // 1. å›ºå®šå ±é…¬
        const finalAmount = amount !== undefined ? amount : 100000;
        state.money += finalAmount;
        updateMoneyUI();

        const ev = EVENT_TYPES[id];
        if (type === 'LEVEL') {
            ev.level += 5;
            pushLog(`ã€ãƒœãƒ¼ãƒŠã‚¹ã€‘${ev.name}ã®ãƒ¬ãƒ™ãƒ«ãŒ 5 ä¸ŠãŒã£ãŸï¼`);
        } else if (type === 'WEIGHT') {
            ev.weight += 10; // å‡ºç¾ç‡ï¼ˆé‡ã¿ï¼‰ã‚’10ã‚¢ãƒƒãƒ—
            pushLog(`ã€ãƒœãƒ¼ãƒŠã‚¹ã€‘${ev.name}ã®å‡ºç¾ç‡ãŒã‚¢ãƒƒãƒ—ã—ãŸï¼`);
        }
        
        updateLevelDisplay();
    }

    // æ‰€æŒé‡‘ã®3%ã‚’è¨ˆç®—ã—ã¦ã‚µã‚¤ã‚³ãƒ­ä»£ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateDiceCost() {
        // æ‰€æŒé‡‘ã®3%ã‚’è¨ˆç®—ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹åˆ‡ã‚Šæ¨ã¦ï¼‰
        // æ‰€æŒé‡‘ãŒãƒã‚¤ãƒŠã‚¹ã®å ´åˆã¯æœ€ä½é¡ï¼ˆä¾‹: 1000å††ï¼‰ã«ã™ã‚‹ãªã©ã®ã‚¬ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã‚‹ã¨å®‰å®šã—ã¾ã™
        const newCost = Math.max(1000, Math.floor(state.money * 0.03));
        
        GAME_CONFIG.DICE_COST = newCost;
        
        // UIè¡¨ç¤ºã®æ›´æ–°
        if (UI.diceCost) {
            UI.diceCost.innerText = GAME_CONFIG.DICE_COST.toLocaleString() + "å††";
        }
        pushLog(`ã€æ”¯å‡ºã‚¢ãƒƒãƒ—ã€‘ã‚µã‚¤ã‚³ãƒ­ä»£ãŒ ${GAME_CONFIG.DICE_COST.toLocaleString()}å††ã«ãªã‚Šã¾ã—ãŸã€‚`);
    }


    function checkYearEnd() {
        // 12æœˆ(ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹11)ã®31æ—¥ã‚’è¶…ãˆãŸã‚‰å®Ÿè¡Œ
        if (state.currentMonthIdx >= 11 && state.currentDay >= 31) {
            showHappyNewYear();
        }
    }

    function showHappyNewYear() {
        const overlay = document.getElementById('new-year-overlay');
        const resultArea = document.getElementById('fortune-result');
        
        // æœ€çµ‚æ‰€æŒé‡‘ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const finalMoney = state.money.toLocaleString();
        
        // ç”»é¢ã‚’è¡¨ç¤º
        overlay.style.display = 'flex';
        resultArea.innerHTML = `2026å¹´ã®ã‚ãªãŸã®é‹æ°—ã¯<br><span style="font-size: 4rem; color: #ffd700;">${finalMoney}å††</span> ã§ã™ï¼`;

        // è±ªè¯ãªæ¼”å‡ºï¼ˆç°¡æ˜“çš„ãªç´™å¹é›ªä»£ã‚ã‚Šã®ãƒ­ã‚°ãªã©ï¼‰
        console.log("HAPPY NEW YEAR!");
        pushLog("â˜…ç¥â˜… 2026å¹´ã«ãªã‚Šã¾ã—ãŸï¼");
    }

    // ==========================================
    // 6. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ==========================================
    function addMoney(amt, src) {
        const gain = Math.floor(amt * state.multiplier);
        state.money += gain;
        updateMoneyUI();
        pushLog(`ã€${src}ã€‘${gain.toLocaleString()}å††ç²å¾—ï¼ (${amt.toLocaleString()} Ã— ${state.multiplier.toFixed(1)}å€)`);
        return gain;
    }

    function subMoney(amt, src) {
        state.money -= amt;
        updateMoneyUI();
        pushLog(`ã€${src}ã€‘${amt.toLocaleString()}å††å¤±ã£ãŸâ€¦`);
    }

    function updateMoneyUI() {
        UI.money.innerText = state.money.toLocaleString() + "å††";
        UI.money.style.color = state.money < 0 ? GAME_CONFIG.COLORS.TEXT_DEBT : GAME_CONFIG.COLORS.TEXT_GOLD;
    }

    function updateMultiplier(val, src) {
        state.multiplier = Math.min(Math.max(state.multiplier + val, 0.1), 10.0);
        UI.multiplier.innerText = state.multiplier.toFixed(1);
        pushLog(`ã€${src}ã€‘å€ç‡ãŒå¤‰åŒ–ï¼ (x${state.multiplier.toFixed(1)})`);
    }

    function pushLog(msg) {
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const mName = MONTHS_DATA[state.currentMonthIdx].name;
        entry.innerHTML = `<strong>[${mName}${state.currentDay}æ—¥]</strong> ${msg}`;
        UI.eventLog.prepend(entry);
        UI.eventLog.scrollTop = 0;
    }

    initGrid();
</script>


<div id="new-year-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: linear-gradient(45deg, #ff0000, #ffd700); z-index:9999; flex-direction:column; align-items:center; justify-content:center; color:white; text-align:center; font-family:'serif';">
    <h1 style="font-size: 5rem; text-shadow: 3px 3px 0px #000; margin-bottom: 20px;">ğŸ ãƒãƒƒãƒ”ãƒ¼ãƒ‹ãƒ¥ãƒ¼ã‚¤ãƒ¤ãƒ¼ï¼ï¼ ğŸ</h1>
    <div id="fortune-result" style="font-size: 2.5rem; background: rgba(0,0,0,0.5); padding: 20px 40px; border-radius: 50px; border: 4px solid #fff;">
        </div>
    <button onclick="location.reload()" style="margin-top: 40px; padding: 15px 30px; font-size: 1.5rem; cursor:pointer; background: #fff; color: #d40000; border:none; border-radius:10px; font-weight:bold;">ã‚‚ã†ä¸€åº¦éŠã¶</button>
</div>
</body>
</html>